<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ±äº¬æ—…éŠè¦åŠƒ App - Firebase å”ä½œç‰ˆ</title>
    <!-- å¼•å…¥ Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ Vue 3 CDN -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- å¼•å…¥ Lucide Icons (ç”¨æ–¼ App Icon) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* å®šç¾©ä¸»é¡Œé¡è‰²ï¼šæ«»èŠ±ç²‰ (Sakura Pink) */
        :root {
            --color-sakura-500: #f472b6; /* Primary Accent */
            --color-sakura-100: #fce7f6; /* Light Background */
            --color-sakura-700: #db2777; /* Dark Text/Hover */
            --color-sakura-900: #9d174d; /* Deep Color */
        }
        .text-sakura { color: var(--color-sakura-500); }
        .bg-sakura-100 { background-color: var(--color-sakura-100); }
        .bg-sakura-500 { background-color: var(--color-sakura-500); }
        .hover\:bg-sakura-700:hover { background-color: var(--color-sakura-700); }
        .border-sakura-400 { border-color: var(--color-sakura-500); }
        .focus\:ring-sakura-500:focus { --tw-ring-color: var(--color-sakura-500); }
        .focus\:border-sakura-500:focus { border-color: var(--color-sakura-500); }

        /* App æ¡†æ¶èˆ‡æ‰‹æ©ŸåŒ–ä»‹é¢ */
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #f0f4f7; /* å¤–éƒ¨èƒŒæ™¯è‰² */
        }
        #app {
            max-width: 420px; /* é™åˆ¶å¯¬åº¦æ¨¡æ“¬æ‰‹æ©Ÿ */
            margin: 0 auto;
            min-height: 100vh;
            background-color: white;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); 
            position: relative;
            padding-bottom: 80px; 
            border-radius: 20px; 
            overflow: hidden;
        }
        .main-content {
            padding: 1rem;
        }
        .nav-icon {
            width: 20px;
            height: 20px;
        }
        /* åº•éƒ¨å°èˆªåˆ—æ¨£å¼ */
        .tab-button {
            transition: all 0.3s;
            border-top: 3px solid transparent;
        }
        .tab-button.active {
            color: var(--color-sakura-700);
            border-top-color: var(--color-sakura-500);
            transform: translateY(-5px);
        }
        /* éš±è—æ»¾å‹•æ¢ä»¥ç²å¾—æ›´ä¹¾æ·¨çš„ç§»å‹•é«”é©— */
        .horizontal-scroll {
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none; 
        }
        .horizontal-scroll::-webkit-scrollbar {
            display: none; 
        }
        .day-pill {
            flex-shrink: 0;
            white-space: nowrap;
        }
        /* æ™‚é–“è»¸ç·šæ¢ (åƒ…ç”¨æ–¼è¦–è¦ºç¾è§€) */
        .timeline-line::before {
            content: '';
            position: absolute;
            top: 0;
            bottom: 0;
            left: 20px; /* Adjust based on li padding */
            width: 2px;
            background-color: #e5e7eb;
            z-index: 0;
        }
        .timeline-dot {
            position: absolute;
            left: 17px; /* Align with line */
            top: 20px;
            z-index: 1;
        }
    </style>
</head>
<body>

<div id="app">
    <!-- Header/Title Bar -->
    <header class="sticky top-0 bg-white p-4 shadow-sm z-10 border-b border-gray-100">
        <h1 class="text-xl font-bold text-gray-800 text-center">
            ğŸŒ¸ æ±äº¬æ—…ç¨‹ <span class="text-base font-normal text-sakura-500 ml-1">å”ä½œè¦åŠƒ</span>
        </h1>
        <!-- é€£ç·šç‹€æ…‹èˆ‡å”ä½œ ID é¡¯ç¤º -->
        <div class="text-center text-xs mt-2 p-1 rounded-lg bg-gray-50 border border-gray-200">
            <p v-if="!isAuthReady" class="text-orange-500">
                <i data-lucide="loader-2" class="nav-icon w-3 h-3 inline-block mr-1 animate-spin"></i>
                é€£ç·šä¸­...
            </p>
            <p v-else-if="userId" class="text-green-600">
                <i data-lucide="users" class="nav-icon w-3 h-3 inline-block mr-1"></i>
                å”ä½œ ID: <span class="font-mono text-xs select-all">{{ userId }}</span>
            </p>
            <p v-else class="text-red-500">
                <i data-lucide="alert-triangle" class="nav-icon w-3 h-3 inline-block mr-1"></i>
                é€£ç·šå¤±æ•—æˆ–åŒ¿åç™»å…¥
            </p>
        </div>
    </header>

    <!-- Main Content Area - Scrollable -->
    <main class="main-content">
        <!-- 1. æ¯æ—¥è¡Œç¨‹è¡¨ (Itinerary) -->
        <div v-show="activeTab === 'itinerary'">
            <h2 class="text-2xl font-semibold mb-4 text-gray-700">æ¯æ—¥è¡Œç¨‹è¦åŠƒ</h2>
            
            <!-- Horizontal Day Picker -->
            <div class="horizontal-scroll flex space-x-3 pb-3 overflow-x-auto mb-6">
                <button
                    v-for="day in uniqueDays"
                    :key="day"
                    @click="selectedDay = day"
                    class="day-pill px-5 py-2 text-sm font-semibold rounded-full border transition duration-150 shadow-md"
                    :class="{'bg-sakura-500 text-white border-sakura-500': selectedDay === day, 'bg-white text-gray-700 border-gray-200 hover:bg-gray-50': selectedDay !== day}"
                >
                    DAY {{ day }}
                </button>
                <button @click="selectedDay = null"
                    class="day-pill px-5 py-2 text-sm font-semibold rounded-full border transition duration-150 text-gray-500 border-dashed border-gray-300 hover:bg-gray-50">
                    <i data-lucide="list-filter" class="nav-icon w-4 h-4 inline-block mr-1"></i> é¡¯ç¤ºå…¨éƒ¨
                </button>
            </div>

            <!-- Add Event Form -->
            <div class="bg-sakura-100 p-4 rounded-xl shadow-inner mb-6 border border-sakura-500/30">
                <h3 class="font-bold text-sakura-700 mb-3 flex items-center">
                    <i data-lucide="map-pin" class="nav-icon w-5 h-5 mr-2"></i> æ–°å¢è¡Œç¨‹
                </h3>
                <div class="space-y-3">
                    <div class="flex space-x-2">
                        <input v-model.number="newEvent.day" type="number" min="1" placeholder="ç¬¬å¹¾å¤© (e.g. 1)" class="w-1/3 p-2 border rounded-lg focus:ring-sakura-500 focus:border-sakura-500 text-sm">
                        <input v-model="newEvent.time" type="time" class="w-2/3 p-2 border rounded-lg focus:ring-sakura-500 focus:border-sakura-500 text-sm">
                    </div>
                    <input v-model="newEvent.location" type="text" placeholder="åœ°é»åç¨± (e.g. æ¾€è°·å¤©ç©º)" class="w-full p-2 border rounded-lg focus:ring-sakura-500 focus:border-sakura-500 text-sm">
                    <textarea v-model="newEvent.details" placeholder="å‚™è¨»/ç´°ç¯€" class="w-full p-2 border rounded-lg focus:ring-sakura-500 focus:border-sakura-500 h-16 text-sm"></textarea>
                    <button @click="addEvent" class="w-full bg-sakura-500 text-white p-3 rounded-xl font-bold hover:bg-sakura-700 transition duration-150 shadow-md" :disabled="!isAuthReady">
                        <i data-lucide="save" class="nav-icon w-4 h-4 inline-block mr-1"></i> å„²å­˜è¡Œç¨‹ ({{ isAuthReady ? 'å·²é€£ç·š' : 'é€£ç·šä¸­...' }})
                    </button>
                </div>
            </div>

            <!-- Itinerary List (Time Line Style) -->
            <div v-for="dayGroup in filteredItineraryGroups" :key="dayGroup.day" class="bg-white p-4 rounded-xl shadow-lg mb-6 border-t-4 border-sakura-400">
                <h3 class="text-xl font-extrabold mb-6 text-sakura-900 flex items-center">
                    DAY {{ dayGroup.day }}
                </h3>
                <ol class="space-y-6 relative timeline-line pl-8">
                    <li v-for="event in dayGroup.events" :key="event.id" class="p-3 pr-0 rounded-lg border-b border-gray-100 flex justify-between items-start hover:bg-gray-50 transition duration-100 relative">
                        <!-- Timeline Dot -->
                        <div class="timeline-dot h-4 w-4 rounded-full bg-sakura-500 border-2 border-white shadow-md"></div>
                        
                        <div class="flex-grow ml-2">
                            <p class="text-base font-semibold text-gray-900">{{ event.location }}</p>
                            <p class="text-xs text-gray-500 mt-1 flex items-center">
                                <i data-lucide="clock" class="nav-icon w-3 h-3 mr-1"></i> {{ event.time }}
                                <span class="ml-3 text-sakura-700 text-xs italic">
                                    {{ getAuthorInitial(event.authorId) }}
                                </span>
                            </p>
                            <p v-if="event.details" class="text-sm text-gray-600 mt-2 p-2 bg-white rounded-md border border-gray-200 shadow-inner">{{ event.details }}</p>
                        </div>
                        <button @click="deleteEvent(event.id)" class="ml-4 text-red-400 hover:text-red-600 p-1 rounded-full transition duration-150 flex-shrink-0">
                            <i data-lucide="trash-2" class="nav-icon w-4 h-4"></i>
                        </button>
                    </li>
                </ol>
            </div>

            <p v-if="itineraryEvents.length === 0" class="text-center text-gray-500 italic p-8">å°šæœªæ–°å¢ä»»ä½•è¡Œç¨‹</p>
            <p class="text-center text-xs text-gray-400 mt-4 p-2 bg-yellow-50 rounded-lg border border-yellow-200">
                <i data-lucide="alert-triangle" class="nav-icon w-3 h-3 inline-block mr-1"></i>
                æ‰€æœ‰è¡Œç¨‹è³‡æ–™å·²å•Ÿç”¨ **Firebase å”ä½œåŠŸèƒ½**ã€‚
            </p>
        </div>

        <!-- 2. åˆ†å¸³ç³»çµ± (Expenses) -->
        <div v-show="activeTab === 'expenses'">
            <div class="space-y-6">
                <h2 class="text-2xl font-semibold mb-4 text-gray-700">æ—…è²»åˆ†å¸³è¨ˆç®—</h2>

                <!-- Exchange Rate Info -->
                <div class="bg-blue-50 p-4 rounded-xl shadow-inner border border-blue-500/30">
                    <h3 class="font-bold text-blue-700 mb-2 flex items-center">
                        <i data-lucide="trending-up" class="nav-icon w-5 h-5 mr-2"></i> åŒ¯ç‡æ›ç®—
                    </h3>
                    <p class="text-sm text-blue-600">
                        ç›®å‰ä½¿ç”¨åŒ¯ç‡ï¼š 1 JPY â‰ˆ **{{ EXCHANGE_RATE_JPY_TWD }} TWD**
                        <span class="text-xs text-gray-500 block mt-1">(æ­¤ç‚ºé è¨­åŒ¯ç‡ï¼Œå¯¦éš›é‡‘é¡è«‹ä»¥ç•¶æ—¥éŠ€è¡Œæˆäº¤åƒ¹ç‚ºæº–)</span>
                    </p>
                </div>

                <!-- Members List -->
                <div class="bg-purple-50 p-4 rounded-xl shadow-inner border border-purple-500/30">
                    <h3 class="font-bold text-purple-700 mb-2">æ—…ä¼´åå–® (ç”¨é€—è™Ÿåˆ†éš”)</h3>
                    <input v-model="memberInput" type="text" placeholder="e.g. Alice, Bob, Carol" class="w-full p-2 border rounded-lg focus:ring-purple-500 focus:border-purple-500 text-sm">
                    <p class="text-xs text-purple-500 mt-2">ç›®å‰æˆå“¡: <span class="font-bold">{{ members.join(', ') }}</span></p>
                </div>

                <!-- Add Expense Form -->
                <div class="bg-green-50 p-4 rounded-xl shadow-inner border border-green-500/30">
                    <h3 class="font-bold text-green-700 mb-3 flex items-center">
                        <i data-lucide="banknote" class="nav-icon w-5 h-5 mr-2"></i> ç´€éŒ„æ”¯å‡º (ä»¥å¤–å¹£è¼¸å…¥)
                    </h3>
                    <div class="space-y-3">
                        <input v-model="newExpense.description" type="text" placeholder="èŠ±è²»é …ç›® (e.g. æ™šé¤)" class="w-full p-2 border rounded-lg focus:ring-green-500 focus:border-green-500 text-sm">
                        
                        <!-- Foreign Currency Input -->
                        <div class="flex items-center space-x-2">
                            <select v-model="newExpense.currency" class="p-2 border rounded-lg bg-gray-100 text-sm">
                                <option value="JPY">JPY (æ—¥åœ“)</option>
                            </select>
                            <input v-model.number="newExpense.amountForeign" type="number" min="0" placeholder="é‡‘é¡ (æ—¥åœ“)" class="w-full p-2 border rounded-lg focus:ring-green-500 focus:border-green-500 text-sm">
                        </div>
                        
                        <!-- Calculated TWD Display -->
                        <p class="text-sm text-gray-700 bg-gray-100 p-2 rounded-lg border border-gray-300">
                            æ›ç®—ç‚ºå°å¹£ (TWD): **NT$ {{ calculatedAmountTWD.toLocaleString() }}**
                        </p>

                        <select v-model="newExpense.payer" class="w-full p-2 border rounded-lg focus:ring-green-500 focus:border-green-500 bg-white text-sm">
                            <option value="" disabled>èª°ä»˜çš„éŒ¢?</option>
                            <option v-for="member in members" :key="member" :value="member">{{ member }}</option>
                        </select>

                        <div class="pt-1 text-sm">
                            <label class="font-medium text-gray-700 block mb-1">åƒèˆ‡åˆ†æ”¤è€…:</label>
                            <div class="flex flex-wrap gap-3">
                                <div v-for="member in members" :key="'p-' + member" class="flex items-center space-x-1">
                                    <input type="checkbox" :id="'part-' + member" :value="member" v-model="newExpense.participants" class="rounded text-green-600 focus:ring-green-500">
                                    <label :for="'part-' + member" class="text-sm">{{ member }}</label>
                                </div>
                            </div>
                        </div>

                        <button @click="addExpense" class="w-full bg-green-500 text-white p-3 rounded-xl font-bold hover:bg-green-700 transition duration-150 shadow-md" :disabled="!newExpense.payer || newExpense.amountForeign <= 0 || newExpense.participants.length === 0 || !isAuthReady">
                            <i data-lucide="plus" class="nav-icon w-4 h-4 inline-block mr-1"></i> ç´€éŒ„æ”¯å‡º
                        </button>
                    </div>
                </div>

                <!-- Expense List -->
                <div class="bg-white p-4 rounded-xl shadow-lg border-t-4 border-gray-300">
                    <h3 class="text-xl font-extrabold mb-3 text-gray-800 flex items-center">
                        <i data-lucide="receipt" class="nav-icon w-5 h-5 mr-2"></i> æ”¯å‡ºç´€éŒ„ ({{ expenses.length }} ç­†)
                    </h3>
                    <ul class="space-y-2">
                        <li v-for="expense in expenses" :key="expense.id" class="p-3 bg-gray-50 rounded-lg border-l-4 border-gray-300 flex justify-between items-center">
                            <div>
                                <p class="font-semibold">{{ expense.description }}
                                    <span class="ml-2 text-sakura-700 text-xs italic">
                                        {{ getAuthorInitial(expense.authorId) }}
                                    </span>
                                </p>
                                <p class="text-sm text-gray-500">
                                    <span class="text-green-600 font-bold">{{ expense.payer }}</span> æ”¯ä»˜äº†
                                    <span class="font-bold text-gray-700">Â¥{{ expense.amountForeign.toLocaleString() }}</span>
                                    <span class="text-xs text-gray-400"> (TWD {{ expense.amount.toLocaleString() }})</span>
                                </p>
                            </div>
                            <button @click="deleteExpense(expense.id)" class="text-red-400 hover:text-red-600">
                                <i data-lucide="x" class="nav-icon w-4 h-4"></i>
                            </button>
                        </li>
                    </ul>
                </div>


                <!-- Settlement Results -->
                <div class="bg-white p-4 rounded-xl shadow-lg border-t-4 border-green-400">
                    <h3 class="text-xl font-extrabold mb-3 text-green-800 flex items-center">
                        <i data-lucide="activity" class="nav-icon w-5 h-5 mr-2"></i> çµç®—çµæœ (ä»¥å°å¹£ TWD è¨ˆç®—)
                    </h3>

                    <div v-if="settlements.length > 0" class="space-y-3">
                        <div v-for="(settlement, index) in settlements" :key="index" class="p-3 bg-green-50 rounded-lg border-l-4 border-green-300">
                            <p class="text-base font-semibold text-gray-800">
                                <span class="text-red-600 font-bold">{{ settlement.from }}</span> æ‡‰æ”¯ä»˜
                                <span class="text-blue-600 font-bold">{{ settlement.to }}</span>
                                <span class="ml-2 text-xl text-green-700 font-extrabold">NT$ {{ settlement.amount.toLocaleString() }}</span>
                            </p>
                        </div>
                    </div>
                    <p v-else class="text-center text-gray-500 italic p-4 bg-gray-50 rounded-lg">è«‹æ–°å¢èŠ±è²»ç´€éŒ„ä¸¦ç¢ºèªæ—…ä¼´åå–®ã€‚</p>
                </div>
            </div>
        </div>

        <!-- 3. åœ°åœ–èˆ‡å°èˆª (Map) -->
        <div v-show="activeTab === 'map'">
            <div class="space-y-6">
                <h2 class="text-2xl font-semibold mb-4 text-gray-700">æ¯æ—¥è¡Œç¨‹åœ°åœ–èˆ‡å°èˆª</h2>
                
                <p class="text-sm text-gray-600 p-3 rounded-xl bg-sakura-100 border border-sakura-300">
                    <i data-lucide="map-pin" class="nav-icon w-4 h-4 inline-block mr-1 text-sakura-600"></i>
                    åœ°åœ–å·²è‡ªå‹•é‡˜é¸ **Day {{ selectedDay }}** çš„æ‰€æœ‰åœ°é» (å…± {{ currentDayLocations.length }} è™•)ã€‚
                </p>

                <!-- Map Placeholder/Iframe -->
                <div class="bg-white p-4 rounded-xl shadow-lg border-t-4 border-red-400">
                    <h3 class="text-xl font-extrabold mb-3 text-red-800 flex items-center">
                         <i data-lucide="map" class="nav-icon w-5 h-5 mr-2"></i> {{ currentDayLocations.join('ã€') || 'æ±äº¬' }} åœ°åœ–æ¦‚è¦½
                    </h3>
                    
                    <div class="w-full h-64 rounded-lg overflow-hidden border border-gray-300">
                        <!-- Google Maps Embed for Multiple Locations -->
                        <iframe
                            :src="multiPointMapUrl"
                            width="100%"
                            height="100%"
                            style="border:0;"
                            allowfullscreen=""
                            loading="lazy"
                            referrerpolicy="no-referrer-when-downgrade">
                        </iframe>
                    </div>

                    <div class="mt-3 p-2 bg-yellow-50 rounded-lg border border-yellow-200">
                        <p class="text-sm text-gray-600 flex items-start">
                            <i data-lucide="locate-fixed" class="nav-icon w-4 h-4 mr-2 flex-shrink-0 mt-0.5 text-red-500"></i>
                            **å®šä½æç¤ºï¼š** åµŒå…¥åœ°åœ–ç„¡æ³•é¡¯ç¤ºæ‚¨çš„å³æ™‚ä½ç½®ã€‚è«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•ï¼Œä½¿ç”¨æ‚¨æ‰‹æ©Ÿ/é›»è…¦çš„ Google åœ°åœ– AppT é€²è¡Œå°èˆªå’Œå®šä½ã€‚
                        </p>
                    </div>
                </div>

                <!-- Navigation Action Button -->
                <a :href="multiPointMapUrl" target="_blank"
                    class="block w-full text-center bg-red-500 text-white p-4 rounded-xl font-bold hover:bg-red-600 transition duration-150 shadow-md">
                    <i data-lucide="navigation" class="nav-icon inline-block mr-2"></i>
                    é–‹å•Ÿå¤–éƒ¨ Google åœ°åœ–å°èˆª (å¤šé»)
                </a>

            </div>
        </div>
    </main>

    <!-- Fixed Bottom Navigation - Clean, Minimalist Tab Bar -->
    <nav class="fixed bottom-0 left-0 right-0 max-w-420 mx-auto bg-white border-t border-gray-100 shadow-2xl z-20 rounded-t-xl">
        <div class="flex justify-around items-center h-16">
            <button @click="activeTab = 'itinerary'" class="flex flex-col items-center justify-center p-2 tab-button w-1/3" :class="{'active': activeTab === 'itinerary', 'text-gray-500': activeTab !== 'itinerary'}">
                <i data-lucide="calendar-check" class="nav-icon"></i>
                <span class="text-xs font-medium mt-1">è¡Œç¨‹è¡¨</span>
            </button>
            <button @click="activeTab = 'expenses'" class="flex flex-col items-center justify-center p-2 tab-button w-1/3" :class="{'active text-green-500': activeTab === 'expenses', 'text-gray-500': activeTab !== 'expenses'}">
                <i data-lucide="wallet" class="nav-icon"></i>
                <span class="text-xs font-medium mt-1">åˆ†å¸³</span>
            </button>
            <button @click="activeTab = 'map'" class="flex flex-col items-center justify-center p-2 tab-button w-1/3" :class="{'active text-red-500': activeTab === 'map', 'text-gray-500': activeTab !== 'map'}">
                <i data-lucide="map" class="nav-icon"></i>
                <span class="text-xs font-medium mt-1">åœ°åœ–</span>
            </button>
        </div>
    </nav>
</div>

<script type="module">
    // Firebase æ¨¡çµ„è¼‰å…¥
    import { initializeApp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, addDoc, deleteDoc, doc, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    
    const { createApp, ref, reactive, computed, watch, nextTick } = Vue
    
    // åŒ¯ç‡å¸¸æ•¸ (1 JPY to TWD - æ¨¡æ“¬å€¼)
    const EXCHANGE_RATE_JPY_TWD = 0.202; 

    // --- æ­¥é©Ÿ 2. åµŒå…¥ Firebase é…ç½®è³‡è¨Š ---
    const MY_FIREBASE_CONFIG = {
        apiKey: "AIzaSy_YOUR_API_KEY_HERE",
        authDomain: "your-project-name.firebaseapp.com",
        projectId: "your-project-id-12345",
        storageBucket: "your-project-name.appspot.com",
        messagingSenderId: "1234567890",
        appId: "1:1234567890:web:abcdefghijk"
    };

    // --- Firebase å…¨åŸŸåˆå§‹åŒ–è¨­å®š ---
    setLogLevel('error'); 

    let db;
    let auth;
    let appId;
    const userId = ref(null);
    const isAuthReady = ref(false);

    // Vue çš„éŸ¿æ‡‰å¼æ•¸æ“šå®¹å™¨ï¼Œç”¨æ–¼å„²å­˜ Firestore åŒæ­¥çš„è³‡æ–™
    const itineraryEvents = reactive([]); 
    const expenses = reactive([]);        

    async function initializeFirebase() {
        try {
            // --- æ­¥é©Ÿ 3 & 4. ä½¿ç”¨åµŒå…¥çš„é…ç½®ç‰©ä»¶ ---
            const firebaseConfig = MY_FIREBASE_CONFIG;
            appId = firebaseConfig.projectId; // åœ¨æ²’æœ‰ __app_id æ™‚ï¼Œä½¿ç”¨ projectId ä½œç‚ºå”ä½œ ID çš„ä¸€éƒ¨åˆ†

            if (!firebaseConfig.apiKey) {
                console.error("Firebase configuration is incomplete. Missing apiKey.");
                return;
            }

            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // è¨­ç½®èº«ä»½é©—è­‰ç‹€æ…‹ç›£è½
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId.value = user.uid;
                } else {
                    // åŒ¿åæˆ–æœªé©—è­‰çš„ç”¨æˆ¶ä½¿ç”¨éš¨æ©Ÿ ID
                    userId.value = 'anon_' + crypto.randomUUID().substring(0, 8); 
                }
                isAuthReady.value = true;
            });

            // ç™»å…¥ï¼šåœ¨ GitHub Pages ç’°å¢ƒä¸‹ï¼Œæ²’æœ‰ __initial_auth_tokenï¼Œç›´æ¥ä½¿ç”¨åŒ¿åç™»å…¥
            await signInAnonymously(auth);

        } catch (error) {
            console.error("Firebase initialization failed:", error);
            isAuthReady.value = true; 
        }
    }
    
    // --- æ•¸æ“šåŒæ­¥ç›£è½ ---
    watch(isAuthReady, (ready) => {
        // IMPORTANT: Check for db and appId availability
        if (!ready || !db || !appId) return;

        // 1. è¡Œç¨‹è¡¨ç›£è½ (å…¬å…±è³‡æ–™é›†)
        // ä½¿ç”¨ projectId ä½œç‚º app_id æ¨¡æ“¬å”ä½œç©ºé–“
        const itineraryCollectionPath = `artifacts/${appId}/public/data/itinerary-events`;
        const itineraryQuery = query(collection(db, itineraryCollectionPath));

        onSnapshot(itineraryQuery, (snapshot) => {
            // æ¸…ç©ºèˆŠæ•¸æ“šä¸¦è¼‰å…¥æ–°æ•¸æ“š
            itineraryEvents.splice(0, itineraryEvents.length); 
            snapshot.forEach((doc) => {
                const data = doc.data();
                itineraryEvents.push({ 
                    id: doc.id, 
                    day: parseInt(data.day), 
                    time: data.time || '00:00',
                    location: data.location || '',
                    details: data.details || '',
                    authorId: data.authorId || 'unknown'
                });
            });
        }, (error) => {
            console.error("Error synchronizing itinerary:", error);
        });

        // 2. åˆ†å¸³ç´€éŒ„ç›£è½ (å…¬å…±è³‡æ–™é›†)
        const expensesCollectionPath = `artifacts/${appId}/public/data/expense-records`;
        const expensesQuery = query(collection(db, expensesCollectionPath));

        onSnapshot(expensesQuery, (snapshot) => {
            expenses.splice(0, expenses.length); 
            snapshot.forEach((doc) => {
                expenses.push({ id: doc.id, ...doc.data() });
            });
        }, (error) => {
            console.error("Error synchronizing expenses:", error);
        });
    }, { immediate: true });


    // --- Vue æ‡‰ç”¨ç¨‹å¼ ---
    createApp({
        setup() {
            // --- ç‹€æ…‹ç®¡ç† ---
            const activeTab = ref('itinerary');
            const selectedDay = ref(1); 
            
            // è¡Œç¨‹è¡¨è¡¨å–®
            const newEvent = reactive({ day: 1, time: '10:00', location: '', details: '' });

            // åˆ†å¸³ç³»çµ±ç‹€æ…‹
            const memberInput = ref('å°æ˜, å°è¯, å°ç¾'); 
            const members = computed(() => memberInput.value.split(',').map(m => m.trim()).filter(m => m.length > 0));
            const newExpense = reactive({ 
                description: '', 
                payer: '', 
                amountForeign: null, 
                currency: 'JPY', 
                participants: [] 
            });

            // --- è¡Œç¨‹è¡¨ç›¸é—œé‚è¼¯ ---
            const itineraryGroups = computed(() => {
                const groups = {};
                // æŒ‰å¤©æ•¸åˆ†çµ„
                itineraryEvents.forEach(event => {
                    const day = event.day;
                    if (day && day > 0) {
                        if (!groups[day]) {
                            groups[day] = { day: day, events: [] }; 
                        }
                        groups[day].events.push(event);
                    }
                });

                // æŒ‰æ™‚é–“æ’åº
                for (const day in groups) {
                    groups[day].events.sort((a, b) => a.time.localeCompare(b.time));
                }

                // è½‰æ›ç‚ºæ’åºå¾Œçš„é™£åˆ—
                return Object.values(groups).sort((a, b) => a.day - b.day);
            });

            const uniqueDays = computed(() => {
                return itineraryGroups.value.map(d => d.day);
            })

            const filteredItineraryGroups = computed(() => {
                if (selectedDay.value === null || !uniqueDays.value.includes(selectedDay.value)) {
                    return itineraryGroups.value; 
                }
                return itineraryGroups.value.filter(d => d.day === selectedDay.value);
            })

            function getAuthorInitial(authorId) {
                // é¡¯ç¤ºä½œè€… ID çš„å‰ 8 å€‹å­—å…ƒ
                return authorId ? `ç”± ${authorId.slice(0, 8)} ç·¨è¼¯` : 'æœªçŸ¥ç”¨æˆ¶';
            }

            async function addEvent() {
                if (!newEvent.day || !newEvent.time || !newEvent.location) {
                    // ä½¿ç”¨æ¨¡æ“¬çš„ alert
                    alert(document.querySelector("#app") ? "è«‹å¡«å¯«æ—¥æœŸã€æ™‚é–“å’Œåœ°é»ï¼" : 'è«‹å¡«å¯«æ—¥æœŸã€æ™‚é–“å’Œåœ°é»ï¼'); 
                    return;
                }
                const dayAsInt = parseInt(newEvent.day);
                if (isNaN(dayAsInt) || dayAsInt <= 0) {
                    console.error('æ—¥æœŸå¿…é ˆæ˜¯æœ‰æ•ˆçš„æ­£æ•´æ•¸');
                    return;
                }
                
                if (!isAuthReady.value || !db || !appId) return;

                try {
                    const collectionRef = collection(db, `artifacts/${appId}/public/data/itinerary-events`);
                    
                    await addDoc(collectionRef, {
                        day: dayAsInt,
                        time: newEvent.time,
                        location: newEvent.location,
                        details: newEvent.details,
                        authorId: userId.value,
                        createdAt: new Date().toISOString() 
                    });

                    // é‡è¨­è¡¨å–®
                    newEvent.time = '10:00';
                    newEvent.location = '';
                    newEvent.details = '';
                    selectedDay.value = dayAsInt; 
                    
                } catch (e) {
                    console.error("Error adding document to Firestore: ", e);
                }
            }

            async function deleteEvent(eventId) {
                if (!db || !appId) return;
                    try {
                        const docRef = doc(db, `artifacts/${appId}/public/data/itinerary-events`, eventId);
                        await deleteDoc(docRef);
                    } catch (e) {
                        console.error("Error deleting document: ", e);
                    }
            }

            // --- åˆ†å¸³ç³»çµ±ç›¸é—œé‚è¼¯ ---
            const calculatedAmountTWD = computed(() => {
                if (newExpense.amountForeign > 0 && newExpense.currency === 'JPY') {
                    // å››æ¨äº”å…¥åˆ°æœ€è¿‘çš„å°å¹£æ•´æ•¸
                    return Math.round(newExpense.amountForeign * EXCHANGE_RATE_JPY_TWD);
                }
                return 0;
            })

            async function addExpense() {
                if (!newExpense.description || !newExpense.payer || newExpense.amountForeign <= 0 || newExpense.participants.length === 0) {
                    // ä½¿ç”¨æ¨¡æ“¬çš„ alert
                    alert(document.querySelector("#app") ? "è«‹ç¢ºä¿æ‰€æœ‰åˆ†å¸³æ¬„ä½éƒ½å·²æ­£ç¢ºå¡«å¯«ï¼" : 'è«‹ç¢ºä¿æ‰€æœ‰åˆ†å¸³æ¬„ä½éƒ½å·²æ­£ç¢ºå¡«å¯«ï¼'); 
                    return;
                }
                if (!isAuthReady.value || !db || !appId) return;

                try {
                    const collectionRef = collection(db, `artifacts/${appId}/public/data/expense-records`);
                    
                    await addDoc(collectionRef, {
                        description: newExpense.description,
                        payer: newExpense.payer,
                        amount: calculatedAmountTWD.value, // TWD amount for settlement
                        amountForeign: newExpense.amountForeign, 
                        currency: newExpense.currency,
                        participants: newExpense.participants.slice(),
                        authorId: userId.value,
                        createdAt: new Date().toISOString()
                    });

                    // é‡è¨­è¡¨å–®
                    newExpense.description = '';
                    newExpense.payer = '';
                    newExpense.amountForeign = null;
                    newExpense.participants = [];
                } catch (e) {
                    console.error("Error adding expense to Firestore: ", e);
                }
            }

            async function deleteExpense(expenseId) {
                 if (!db || !appId) return;
                    try {
                        const docRef = doc(db, `artifacts/${appId}/public/data/expense-records`, expenseId);
                        await deleteDoc(docRef);
                    } catch (e) {
                        console.error("Error deleting expense: ", e);
                    }
            }

            const settlements = computed(() => {
                // çµç®—é‚è¼¯
                if (members.value.length === 0 || expenses.length === 0) {
                    return [];
                }

                const netBalances = {};
                members.value.forEach(m => netBalances[m] = 0);

                // 1. è¨ˆç®—æ·¨é¤˜é¡
                expenses.forEach(expense => {
                    if (expense.participants && expense.participants.length > 0) {
                        const share = expense.amount / expense.participants.length; 
                        // ä»˜æ¬¾äººå¾—åˆ°å…¨éƒ¨é‡‘é¡
                        netBalances[expense.payer] = (netBalances[expense.payer] || 0) + expense.amount;
                        // åƒèˆ‡è€…æ”¯ä»˜åˆ†æ”¤é‡‘é¡
                        expense.participants.forEach(p => {
                            netBalances[p] = (netBalances[p] || 0) - share;
                        });
                    }
                });
                
                let creditors = []; // è¢«æ¬ éŒ¢ (> 0)
                let debtors = [];   // æ¬ åˆ¥äººéŒ¢ (< 0)

                // 2. åˆ†é›¢å‚µæ¬Šäººå’Œå‚µå‹™äºº
                for (const member in netBalances) {
                    const balance = netBalances[member];
                    if (Math.abs(balance) > 0.5) { // å¿½ç•¥å¾®å°é¤˜é¡
                        const item = { name: member, amount: Math.round(Math.abs(balance)) }; 
                        if (balance > 0) {
                            creditors.push(item);
                        } else {
                            debtors.push(item);
                        }
                    }
                }
                
                // 3. ç°¡åŒ–çµç®— (Simple Settlement Algorithm)
                let settlements = [];
                let i = 0; // Debtors pointer
                let j = 0; // Creditors pointer

                while (i < debtors.length && j < creditors.length) {
                    let debtor = debtors[i];
                    let creditor = creditors[j];
                    
                    const amountToSettle = Math.min(debtor.amount, creditor.amount);

                    if (amountToSettle > 0) {
                        settlements.push({
                            from: debtor.name,
                            to: creditor.name,
                            amount: amountToSettle 
                        });

                        debtor.amount -= amountToSettle;
                        creditor.amount -= amountToSettle;
                    }

                    if (debtor.amount < 0.5) { i++; }
                    if (creditor.amount < 0.5) { j++; }
                }

                return settlements;
            })

            // --- åœ°åœ–èˆ‡å°èˆªç›¸é—œé‚è¼¯ ---
            const currentDayEvents = computed(() => {
                 return itineraryEvents.filter(e => e.day === selectedDay.value);
            });

            const currentDayLocations = computed(() => {
                // å–å¾—é¸å®šæ—¥æœŸçš„å”¯ä¸€åœ°é»åç¨±
                const locations = currentDayEvents.value.map(e => e.location).filter(l => l.trim().length > 0);
                return [...new Set(locations)];
            });

            const multiPointMapUrl = computed(() => {
                const locations = currentDayLocations.value;
                // Google Maps åµŒå…¥ API åƒ…æ”¯æ´å–®é»æˆ–æ–¹å‘ï¼Œå¤šé»é¡¯ç¤ºç”¨æŸ¥è©¢å­—ä¸²æ¨¡æ“¬
                if (locations.length === 0) {
                    // é è¨­ç‚ºæ±äº¬è»Šç«™
                    return "https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3240.828030380844!2d139.7641324152589!3d35.68123618019349!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x60188b901e18d363%3A0x7d288d011f054700!2z5p2x5Lqs6aeF6aeT!5e0!3m2!1szh-TW!2stw!4v1678848000000!5m2!1szh-TW!2stw";
                }

                // çµ„åˆåœ°é»åç¨±é€²è¡Œ Google Maps æŸ¥è©¢ï¼Œå¼·åˆ¶å¸¶å…¥æ±äº¬
                const locationString = locations.join(' and ') + ', Tokyo';
                // ä½¿ç”¨ place æŸ¥è©¢ä¸¦å°‡çµæœåµŒå…¥
                // æ³¨æ„: é€™è£¡éœ€è¦æ‚¨è‡ªå·±çš„ Google Maps API Key æ‰èƒ½æ­£å¸¸é‹ä½œï¼Œä½†ç‚ºäº†å®‰å…¨æ€§ï¼Œæˆ‘ä¸æœƒåœ¨ç¨‹å¼ç¢¼ä¸­ç¡¬ç·¨ç¢¼ã€‚
                // ç”±æ–¼æ²’æœ‰ API Keyï¼Œé€™å€‹ URL å¯èƒ½åœ¨æŸäº›ç’°å¢ƒä¸‹ç„¡æ³•é¡¯ç¤ºåœ°åœ–ï¼Œä½†é‚è¼¯æ˜¯æ­£ç¢ºçš„ã€‚
                return `https://www.google.com/maps/embed/v1/place?key=&q=${encodeURIComponent(locationString)}`;
            });

            // --- åˆå§‹åŒ–èˆ‡ç›£è½ ---

            // ç•¶è¡Œç¨‹è¡¨æ•¸æ“šæ”¹è®Šæ™‚ï¼Œè‡ªå‹•é¸æ“‡ç¬¬ä¸€å€‹æˆ–ç¾æœ‰çš„ä¸€å¤©
            watch(itineraryEvents, (newEvents) => {
                if (newEvents.length > 0) {
                    const firstDay = Math.min(...newEvents.map(e => e.day));
                    if (selectedDay.value === null || !uniqueDays.value.includes(selectedDay.value)) {
                        selectedDay.value = firstDay;
                    }
                } else {
                    selectedDay.value = 1;
                }
                // ç¢ºä¿ icons åœ¨ DOM æ›´æ–°å¾Œè¢«æ¸²æŸ“
                nextTick(() => { lucide.createIcons(); });
            }, { immediate: true });

            // ç¢ºä¿æ¯æ¬¡åˆ‡æ› Tab æ™‚ icons éƒ½è¢«æ¸²æŸ“
            watch(activeTab, async () => {
                await nextTick();
                lucide.createIcons();
            }, { immediate: true });

            // åŸ·è¡Œ Firebase åˆå§‹åŒ–
            initializeFirebase();

            return {
                EXCHANGE_RATE_JPY_TWD,
                activeTab,
                isAuthReady,
                userId,
                
                // è¡Œç¨‹
                itineraryEvents, 
                itineraryGroups, 
                newEvent,
                addEvent,
                deleteEvent,
                uniqueDays,
                selectedDay,
                filteredItineraryGroups,
                getAuthorInitial,
                
                // åˆ†å¸³
                memberInput,
                members,
                expenses, 
                newExpense,
                addExpense,
                deleteExpense,
                calculatedAmountTWD, 
                settlements,

                // åœ°åœ–
                currentDayLocations,
                multiPointMapUrl
            }
        }
    }).mount('#app')
</script>

</body>
</html>